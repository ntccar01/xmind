<!-- index.html -->
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>å¿ƒæ™ºåœ–è£½ä½œå·¥å…·</title>
  
  <!-- [å¯é¸] ç›´æ¥åœ¨æ­¤è™•è²¼ä¸Šæ‚¨çš„ GAS ç¶²è·¯æ‡‰ç”¨ç¨‹å¼ URL -->
  <script>
    var hardcodedGasUrl = 'https://script.google.com/macros/s/AKfycbxqubHzimi_GwYeVYFXNWhposIzuPcvvXluSsLp_Bd6RTNAOiT3UG6UtOREPoqKrhF6/exec';
  </script>

  <style>
    html, body { height:100%; margin:0; padding:0; font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; overflow:hidden; }
    
    /* Hamburger Menu Button */
    #menu_toggle { position:fixed; top:15px; left:15px; width: 40px; height: 40px; background: #2c3e50; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 200; box-shadow: 0 4px 10px rgba(0,0,0,0.3); border: 2px solid #34495e; }
    #menu_toggle span, #menu_toggle span:before, #menu_toggle span:after { content: ''; position: absolute; width: 20px; height: 2px; background: #ecf0f1; transition: all 0.3s; }
    #menu_toggle span:before { transform: translateY(-6px); }
    #menu_toggle span:after { transform: translateY(6px); }
    #menu_toggle.active span { background: transparent; }
    #menu_toggle.active span:before { transform: rotate(45deg); }
    #menu_toggle.active span:after { transform: rotate(-45deg); }

    /* Top Slide-down Menu */
    #top_menu { position: fixed; top: -150px; left: 0; right: 0; background: #34495e; padding: 15px 20px; display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 15px; box-shadow: 0 2px 6px rgba(0,0,0,0.3); z-index: 100; transition: top 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
    #top_menu.active { top: 0; }
    .btn { padding: 8px 16px; border:none; border-radius: 20px; font-size: 14px; color: #fff; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.2); transition: transform .1s, box-shadow .1s; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.3); }
    .menu-separator { width: 2px; height: 25px; background-color: #4a6572; border-radius: 1px; }
    #md_input_label { padding: 8px 16px; border-radius: 20px; font-size: 14px; color: #fff; cursor: pointer; background-image: linear-gradient(45deg,#81c784,#388e3c); box-shadow: 0 4px 8px rgba(0,0,0,0.2); transition: transform .1s, box-shadow .1s; }
    #md_input_label:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.3); }
    #md_input { display: none; }
    #btn_download { background-image: linear-gradient(45deg,#29b6f6,#0288d1); }
    #btn_export_md { background-image: linear-gradient(45deg,#9575cd,#5e35b1); }
    #btn_open_cloud { background-image: linear-gradient(45deg, #66bb6a, #388e3c); }
    #btn_save_cloud { background-image: linear-gradient(45deg,#fdd835,#fbc02d); color: #333;}
    #btn_settings { background-image: linear-gradient(45deg,#90a4ae,#607d8b); }
    #btn_help { background-image: linear-gradient(45deg, #7986cb, #3f51b5); }

    /* Floating Action Buttons */
    #fab_container { position: fixed; top: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 150; }
    .fab { width: 48px; height: 48px; border-radius: 50%; border: none; color: white; font-size: 24px; line-height: 48px; text-align: center; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: all 0.2s; }
    .fab:hover { transform: scale(1.1); box-shadow: 0 6px 16px rgba(0,0,0,0.4); }
    #btn_add_child { background-image: linear-gradient(45deg, #ff8a65, #f4511e); }
    #btn_add_sibling { background-image: linear-gradient(45deg, #4db6ac, #00897b); }
    #btn_delete { background-image: linear-gradient(45deg, #f06292, #e91e63); }
    #btn_add_link { background-image: linear-gradient(45deg, #4dd0e1, #00acc1); }
    #btn_add_image { background-image: linear-gradient(45deg, #ffab40, #ff6f00); }
    #btn_toggle_all { background-image: linear-gradient(45deg, #ab47bc, #8e24aa); }
    #btn_presentation { background-image: linear-gradient(45deg, #5c6bc0, #3f51b5); }
    #btn_reorder { background-image: linear-gradient(45deg, #546e7a, #37474f); }

    /* Modal Styles */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 1000; }
    .modal-content { background: #fff; padding: 25px; border-radius: 10px; width: 90%; max-width: 700px; box-shadow: 0 5px 20px rgba(0,0,0,0.4); display: flex; flex-direction: column; max-height: 90vh; }
    .modal-content h2 { margin-top: 0; color: #333; }
    .modal-body { overflow-y: auto; }
    .modal-content .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; flex-shrink: 0; }
    .modal-buttons .btn { background-image: linear-gradient(45deg, #546e7a, #37474f); } /* Darker Button Style */
    .modal-input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 14px; box-sizing: border-box; }

    /* Cloud Files Modal Specific */
    #cloud_files_list_container { max-height: 60vh; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; }
    #cloud_files_list { list-style: none; padding: 0; margin: 0; }
    #cloud_files_list li { display: flex; align-items: center; justify-content: space-between; padding: 12px 15px; border-bottom: 1px solid #eee; }
    #cloud_files_list li:last-child { border-bottom: none; }
    #cloud_files_list .file-info { cursor: pointer; flex-grow: 1; }
    #cloud_files_list .file-info:hover { background-color: #f5f5f5; margin: -12px -15px; padding: 12px 15px; }
    #cloud_files_list .file-name { font-weight: bold; color: #333; }
    #cloud_files_list .file-meta { font-size: 12px; color: #777; margin-top: 4px; }
    #cloud_files_list .file-meta span { margin-right: 10px; }
    .btn-delete-cloud { background-image: linear-gradient(45deg, #ef5350, #c62828); padding: 5px 12px; margin-left: 15px; }

    /* Help Modal Specific */
    #help_modal h3 { border-bottom: 2px solid #3498db; padding-bottom: 5px; margin-top: 25px; }
    #help_modal p, #help_modal li { line-height: 1.6; color: #333; }
    #help_modal .code-container { position: relative; margin-top: 15px; }
    #help_modal pre { background-color: #2d2d2d; color: #f1f1f1; padding: 15px; border-radius: 5px; white-space: pre-wrap; word-wrap: break-word; max-height: 400px; overflow-y: auto; }
    #btn_copy_gas_code { position: absolute; top: 10px; right: 10px; background: #7f8c8d; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
    #btn_copy_gas_code:hover { background: #95a5a6; }
    #help_modal .pros-cons { border-left: 4px solid #f1c40f; padding-left: 15px; margin-top: 10px; }

    /* Notification Layer */
    #notification_layer { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); padding: 12px 25px; border-radius: 20px; color: #fff; font-size: 16px; z-index: 2000; box-shadow: 0 5px 15px rgba(0,0,0,0.3); transition: top 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
    #notification_layer.show { top: 20px; }
    #notification_layer.success { background-color: #2ecc71; }
    #notification_layer.error { background-color: #e74c3c; }

    /* Mindmap Container */
    #jsmind_container { position: absolute; top: 0; bottom: 0; left: 0; right: 0; background: #ecf0f1; cursor: grab; overflow: hidden; }
    .jsmind-inner { overflow:visible!important; transform-origin: 0 0; }
    #jsmind_container.grabbing { cursor: grabbing; }
    #attribution { position:absolute; bottom:10px; right:10px; padding:4px 8px; background:rgba(0,0,0,0.5); color:#fff; border-radius:4px; font-size:12px; z-index:10; }
    #attribution a { color:#ffd54f; text-decoration:none; }

    /* Presentation Mode Styles */
    .presentation-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1e3c72, #2a5298); display: none; z-index: 2000; }
    .presentation-content { width: 100%; height: 100%; display: flex; flex-direction: column; color: white; }
    .presentation-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 40px; background: rgba(0,0,0,0.2); }
    .presentation-breadcrumb { font-size: 14px; opacity: 0.7; }
    .presentation-controls { display: flex; align-items: center; gap: 15px; }
    .presentation-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background 0.2s; }
    .presentation-btn:hover { background: rgba(255,255,255,0.3); }
    .presentation-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .slide-counter { font-size: 14px; min-width: 60px; text-align: center; }
    .presentation-main { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 60px; text-align: center; position: relative; }
    .presentation-breadcrumb-corner { position: absolute; top: 30px; left: 30px; font-size: 16px; opacity: 0.5; line-height: 1.4; max-width: 300px; }
    .presentation-title { font-size: 8em; font-weight: bold; line-height: 1.1; text-shadow: 3px 3px 6px rgba(0,0,0,0.4); max-width: 90%; word-wrap: break-word; transition: opacity 1.2s ease-in-out; opacity: 1; }
    .presentation-title.active { opacity: 1; }
    .presentation-title.fade-out { opacity: 0 !important; }
    .presentation-title.fade-in { opacity: 0 !important; }
    .presentation-children { display: none; }
    .presentation-child { display: none; }
    .presentation-child:hover { display: none; }
    .presentation-child.selected { display: none; }
  </style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsmind@0.6.1/style/jsmind.css">
  <script src="https://cdn.jsdelivr.net/npm/jsmind@0.6.1/js/jsmind.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsmind@0.6.1/js/jsmind.draggable-node.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>

  <div id="menu_toggle"><span></span></div>

  <div id="top_menu">
    <!-- Cloud Group -->
    <button id="btn_save_cloud" class="btn">é›²ç«¯å­˜æª”</button>
    <button id="btn_open_cloud" class="btn">é–‹å•Ÿé›²ç«¯æª”æ¡ˆ</button>
    <div class="menu-separator"></div>
    <!-- Local File Group -->
    <button id="btn_open_md_import" class="btn" style="background-image: linear-gradient(45deg,#81c784,#388e3c);">åŒ¯å…¥ MD</button>
    <button id="btn_download" class="btn">ä¸‹è¼‰ HTML</button>
    <button id="btn_export_md" class="btn">åŒ¯å‡º MD</button>
    <div class="menu-separator"></div>
    <!-- App/Meta Group -->
    <button id="btn_settings" class="btn">è¨­å®š</button>
    <button id="btn_help" class="btn">èªªæ˜</button>
  </div>

  <div id="fab_container">
    <button id="btn_add_child" class="fab" title="æ–°å¢å­ç¯€é»">+</button>
    <button id="btn_add_sibling" class="fab" title="æ–°å¢åŒéšç¯€é»">~</button>
    <button id="btn_delete" class="fab" title="åˆªé™¤ç¯€é»">-</button>
    <button id="btn_add_link" class="fab" title="æ–°å¢/ç·¨è¼¯è¶…é€£çµ">ğŸ”—</button>
    <button id="btn_add_image" class="fab" title="æ–°å¢/ç·¨è¼¯åœ–ç‰‡">ğŸ–¼ï¸</button>
    <button id="btn_reorder" class="fab" title="å·¦å³æ’åˆ—">â†”</button>
    <button id="btn_toggle_all" class="fab" title="å±•é–‹/æ”¶åˆæ‰€æœ‰ç¯€é»">âš¡</button>
    <button id="btn_presentation" class="fab" title="ç°¡å ±æ¨¡å¼">ğŸ“º</button>
  </div>

  <div id="jsmind_container"></div>
  <div id="attribution">Made by <a href="https://kentxchang.blogspot.tw" target="_blank" rel="noopener">é˜¿å‰›è€å¸«</a></div>
  <div id="notification_layer"></div>

  <!-- Presentation Mode -->
  <div id="presentation_overlay" class="presentation-overlay">
    <div class="presentation-content">
      <div class="presentation-header">
        <div class="presentation-breadcrumb"></div>
        <div class="presentation-controls">
          <button class="presentation-btn" id="btn_prev_slide">â—€</button>
          <span class="slide-counter"></span>
          <button class="presentation-btn" id="btn_next_slide">â–¶</button>
          <button class="presentation-btn" id="btn_exit_presentation">âœ•</button>
        </div>
      </div>
      <div class="presentation-main">
        <div class="presentation-breadcrumb-corner"></div>
        <div class="presentation-title"></div>
        <div class="presentation-children"></div>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div id="md_import_modal_overlay" class="modal-overlay">
    <div class="modal-content">
        <h2>åŒ¯å…¥ Markdown</h2>
        <div class="modal-body">
            <p>è«‹é¸æ“‡ä¸€å€‹ .md æˆ– .txt æª”æ¡ˆä¸Šå‚³ï¼š</p>
            <input type="file" id="md_file_input" accept=".md,.txt" class="modal-input">
            <p style="text-align: center; margin: 15px 0;">æˆ–</p>
            <p>ç›´æ¥è²¼ä¸Š Markdown æ–‡å­—åˆ°ä¸‹æ–¹ï¼š</p>
            <textarea id="md_text_input" class="modal-input" rows="10" placeholder="# æ ¹ç¯€é»..."></textarea>
        </div>
        <div class="modal-buttons" style="display: flex; justify-content: space-between; align-items: center;">
            <button id="btn_show_prompt" class="btn" style="background-image: linear-gradient(45deg,#64b5f6,#2196f3);">åƒè€ƒ Prompt</button>
            <div>
                <button id="btn_cancel_md_import" class="btn">å–æ¶ˆ</button>
                <button id="btn_process_md_import" class="btn">é–‹å§‹åŒ¯å…¥</button>
            </div>
        </div>
    </div>
  </div>

  <div id="settings_modal_overlay" class="modal-overlay">
      <div class="modal-content">
          <h2>é›²ç«¯å„²å­˜è¨­å®š</h2>
          <p>è«‹è²¼ä¸Šæ‚¨å¾ Google Apps Script å–å¾—çš„ç¶²è·¯æ‡‰ç”¨ç¨‹å¼ URLã€‚</p>
          <input type="text" id="gas_url_input" class="modal-input">
          <div class="modal-buttons">
              <button id="btn_cancel_settings" class="btn">å–æ¶ˆ</button>
              <button id="btn_save_settings" class="btn">å„²å­˜</button>
          </div>
      </div>
  </div>

  <div id="cloud_files_modal_overlay" class="modal-overlay">
      <div class="modal-content">
          <h2>é–‹å•Ÿé›²ç«¯æª”æ¡ˆ</h2>
          <div id="cloud_filter_bar" style="display: flex; gap: 15px; margin-bottom: 15px; align-items: center;">
            <select id="uploader_filter" class="modal-input" style="flex-basis: 200px;"></select>
            <input type="text" id="keyword_filter" class="modal-input" placeholder="ä¾é—œéµå­—æœå°‹..." style="flex-grow: 1;">
          </div>
          <div id="cloud_files_list_container" class="modal-body"><ul id="cloud_files_list"></ul></div>
          <div class="modal-buttons">
              <button id="btn_close_cloud_files" class="btn">é—œé–‰</button>
          </div>
      </div>
  </div>

  <div id="uploader_modal_overlay" class="modal-overlay">
      <div class="modal-content">
          <h2>ä¸Šå‚³è€…è³‡è¨Š</h2>
          <p>è«‹è¼¸å…¥æ‚¨çš„åç¨±æˆ–ä»£è™Ÿ (é¸å¡«)</p>
          <input type="text" id="uploader_name_input" class="modal-input">
          <div class="modal-buttons">
              <button id="btn_cancel_uploader" class="btn">å–æ¶ˆ</button>
              <button id="btn_confirm_uploader" class="btn">ç¢ºèªä¸¦å„²å­˜</button>
          </div>
      </div>
  </div>

  <div id="help_modal_overlay" class="modal-overlay">
      <div id="help_modal" class="modal-content">
          <h2>é›²ç«¯åŒæ­¥è¨­å®šèªªæ˜</h2>
          <div class="modal-body">
              <h3>å…©ç¨® URL è¨­å®šæ–¹å¼æ¯”è¼ƒ</h3>
              <p>æ‚¨å¯ä»¥é¸æ“‡ä»¥ä¸‹å…©ç¨®æ–¹å¼ä¾†è¨­å®šæ‚¨çš„ Google Apps Script (GAS) ç¶²å€ï¼š</p>
              <div class="pros-cons">
                  <p><strong>æ–¹æ³•ä¸€ï¼šç›´æ¥å¯«å…¥ HTML (æ¨è–¦)</strong></p>
                  <p><strong>å„ªé»ï¼š</strong>æœ€ç°¡å–®ã€ä¸€å‹æ°¸é€¸ã€‚åªè¦ä¿®æ”¹ HTML æª”ï¼Œæ‰€æœ‰ä½¿ç”¨è€…éƒ½èƒ½ç›´æ¥ä½¿ç”¨ï¼Œç„¡éœ€é¡å¤–è¨­å®šã€‚</p>
                  <p><strong>ç¼ºé»ï¼š</strong>æ¯æ¬¡æ›´æ–° GAS ç¶²å€æ™‚ï¼Œéƒ½éœ€è¦é‡æ–°ä¿®æ”¹ä¸¦åˆ†ç™¼ HTML æª”æ¡ˆã€‚</p>
              </div>
              <div class="pros-cons" style="border-color: #3498db; margin-top: 15px;">
                  <p><strong>æ–¹æ³•äºŒï¼šä½¿ç”¨ã€Œè¨­å®šã€ä»‹é¢</strong></p>
                  <p><strong>å„ªé»ï¼š</strong>éˆæ´»ï¼Œä½¿ç”¨è€…å¯ä»¥åœ¨ä¸ä¿®æ”¹ç¨‹å¼ç¢¼çš„æƒ…æ³ä¸‹ï¼Œè‡ªè¡Œæ›´æ› GAS ç¶²å€ã€‚</p>
                  <p><strong>ç¼ºé»ï¼š</strong>æ¯å€‹ä½¿ç”¨è€…éƒ½éœ€è¦æ‰‹å‹•è¨­å®šä¸€æ¬¡ã€‚ç¶²å€å„²å­˜åœ¨ç€è¦½å™¨çš„ Local Storage ä¸­ï¼Œè‹¥æ¸…é™¤ç€è¦½å™¨è³‡æ–™æˆ–æ›´æ›é›»è…¦ï¼Œå°±éœ€è¦é‡æ–°è¨­å®šã€‚</p>
              </div>

              <h3>æ­¥é©Ÿä¸€ï¼šå–å¾— GAS ç¨‹å¼ç¢¼</h3>
              <p>ä¸‹æ–¹çš„å€å¡Šæ˜¯æ‚¨éœ€è¦ç”¨åˆ°çš„å®Œæ•´ GAS ç¨‹å¼ç¢¼ã€‚è«‹é»æ“Šå³ä¸Šè§’çš„æŒ‰éˆ•å°‡å…¶è¤‡è£½ã€‚</p>
              <div class="code-container">
                  <button id="btn_copy_gas_code">è¤‡è£½ GAS ç¨‹å¼ç¢¼</button>
                  <pre><code id="gas_code_block">/**
 * @OnlyCurrentDoc
 * å¿ƒæ™ºåœ–è³‡æ–™é›²ç«¯å„²å­˜ Google Apps Script (ES5 ç›¸å®¹ç‰ˆ)
 * ä½œè€…: é˜¿å‰›è€å¸« (ä¿®æ”¹ by Gemini)
 * åŠŸèƒ½: æ¥æ”¶ä¾†è‡ªå¿ƒæ™ºåœ–å·¥å…·çš„è³‡æ–™ï¼Œä¸¦å­˜å„²/è®€å–/åˆªé™¤åœ¨ç¶å®šçš„ Google è©¦ç®—è¡¨ä¸­ã€‚
 */

// --- å¸¸æ•¸è¨­å®š ---
var SHEET_LIST_NAME = 'å¿ƒæ™ºåœ–åˆ—è¡¨';
var SHEET_DATA_NAME = 'å¿ƒæ™ºåœ–è³‡æ–™';
var LIST_HEADERS = ['å¿ƒæ™ºåœ–åç¨±', 'ä¸Šå‚³è€…', 'æ›´æ–°æ™‚é–“', 'è³‡æ–™ID'];
var DATA_HEADERS = ['è³‡æ–™ID', 'å¿ƒæ™ºåœ–å…§å®¹ (JSON)'];

/**
 * ç•¶æ­¤ Script ä½œç‚º Web App æ¥æ”¶åˆ° GET è«‹æ±‚æ™‚åŸ·è¡Œ
 */
function doGet(e) {
  try {
    var action = e.parameter.action;
    var ss = setupSheets();
    var listSheet = ss.listSheet;
    var dataSheet = ss.dataSheet;

    if (action === 'getList') {
      var listData = listSheet.getDataRange().getValues();
      listData.shift(); // ç§»é™¤æ¨™é ­
      var result = [];
      for (var i = 0; i < listData.length; i++) {
        result.push({
          name: listData[i][0],
          uploader: listData[i][1],
          updateTime: listData[i][2],
          id: listData[i][3]
        });
      }
      return createJsonResponse({ status: 'success', data: result.reverse() });

    } else if (action === 'getMap' && e.parameter.id) {
      var dataId = e.parameter.id;
      var dataSheetData = dataSheet.getDataRange().getValues();
      dataSheetData.shift(); // ç§»é™¤æ¨™é ­
      var foundRow = null;
      for (var j = 0; j < dataSheetData.length; j++) {
        if (dataSheetData[j][0] === dataId) {
          foundRow = dataSheetData[j];
          break;
        }
      }
      if (foundRow) {
        return createJsonResponse({ status: 'success', data: foundRow[1] });
      } else {
        throw new Error('æ‰¾ä¸åˆ°å°æ‡‰çš„è³‡æ–™ID: ' + dataId);
      }

    } else {
      throw new Error('ç„¡æ•ˆçš„æ“ä½œæˆ–ç¼ºå°‘åƒæ•¸ (action=getList æˆ– action=getMap&id=...)');
    }

  } catch (error) {
    return createJsonResponse({ status: 'error', message: error.message });
  }
}

/**
 * ç•¶æ­¤ Script ä½œç‚º Web App æ¥æ”¶åˆ° POST è«‹æ±‚æ™‚åŸ·è¡Œ
 */
function doPost(e) {
  try {
    var ss = setupSheets();
    var listSheet = ss.listSheet;
    var dataSheet = ss.dataSheet;

    if (!e || !e.postData || !e.postData.contents) {
      throw new Error('ç„¡æ•ˆçš„è«‹æ±‚è³‡æ–™ã€‚');
    }
    var postData = JSON.parse(e.postData.contents);
    var action = postData.action || 'save'; // é è¨­ action ç‚º 'save'

    if (action === 'save') {
      return handleSave(postData, listSheet, dataSheet);
    } else if (action === 'deleteMap') {
      return handleDelete(postData, listSheet, dataSheet);
    } else {
      throw new Error('ç„¡æ•ˆçš„ POST æ“ä½œã€‚');
    }

  } catch (error) {
    return createJsonResponse({ status: 'error', message: error.message, stack: error.stack });
  }
}

/**
 * è™•ç†å„²å­˜å¿ƒæ™ºåœ–çš„é‚è¼¯
 */
function handleSave(postData, listSheet, dataSheet) {
  var mindMapName = postData.name;
  var mindMapContent = postData.content;
  var uploader = postData.uploader || '';

  if (!mindMapName || !mindMapContent) {
    throw new Error('å‚³å…¥çš„è³‡æ–™æ ¼å¼ä¸æ­£ç¢ºï¼Œç¼ºå°‘ \'name\' æˆ– \'content\'.');
  }

  var listData = listSheet.getDataRange().getValues();
  var nameExists = false;
  for (var i = 1; i < listData.length; i++) {
    if (listData[i][0] === mindMapName) {
      nameExists = true;
      break;
    }
  }

  var now = new Date();

  if (nameExists) {
    // If name exists, append timestamp to make it unique
    var timestamp = Utilities.formatDate(now, Session.getScriptTimeZone(), " (yyyy-MM-dd HH:mm:ss)");
    mindMapName += timestamp;
  }

  // Always create a new entry
  var dataId = generateUUID();
  listSheet.appendRow([mindMapName, uploader, now, dataId]);
  dataSheet.appendRow([dataId, mindMapContent]);
  return createJsonResponse({ status: 'success', message: "å¿ƒæ™ºåœ– '" + mindMapName + "' å·²æˆåŠŸæ–°å¢ã€‚" });
}

/**
 * è™•ç†åˆªé™¤å¿ƒæ™ºåœ–çš„é‚è¼¯
 */
function handleDelete(postData, listSheet, dataSheet) {
  var dataId = postData.id;
  if (!dataId) {
    throw new Error('ç¼ºå°‘è¦åˆªé™¤çš„è³‡æ–™IDã€‚');
  }

  var listData = listSheet.getDataRange().getValues();
  var listRowToDelete = -1;
  for (var i = 1; i < listData.length; i++) {
    if (listData[i][3] === dataId) {
      listRowToDelete = i + 1;
      break;
    }
  }

  if (listRowToDelete > -1) {
    listSheet.deleteRow(listRowToDelete);
  }

  var dataSheetData = dataSheet.getDataRange().getValues();
  var dataRowToDelete = -1;
  for (var j = 1; j < dataSheetData.length; j++) {
    if (dataSheetData[j][0] === dataId) {
      dataRowToDelete = j + 1;
      break;
    }
  }

  if (dataRowToDelete > -1) {
    dataSheet.deleteRow(dataRowToDelete);
  }
  
  if (listRowToDelete > -1 || dataRowToDelete > -1) {
      return createJsonResponse({ status: 'success', message: 'è³‡æ–™å·²æˆåŠŸåˆªé™¤ã€‚' });
  } else {
      throw new Error('åœ¨è©¦ç®—è¡¨ä¸­æ‰¾ä¸åˆ°è¦åˆªé™¤çš„è³‡æ–™ID: ' + dataId);
  }
}

/**
 * æª¢æŸ¥ä¸¦åˆå§‹åŒ–æ‰€éœ€çš„å·¥ä½œè¡¨å’Œæ¨™é ­
 */
function setupSheets() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var listSheet = ss.getSheetByName(SHEET_LIST_NAME);
  if (!listSheet) {
    listSheet = ss.insertSheet(SHEET_LIST_NAME);
    listSheet.appendRow(LIST_HEADERS);
    listSheet.setFrozenRows(1);
    listSheet.getRange('A:D').applyRowBanding();
    listSheet.setColumnWidth(1, 250);
    listSheet.setColumnWidth(2, 150);
    listSheet.setColumnWidth(3, 200);
    listSheet.setColumnWidth(4, 300);
  }

  var dataSheet = ss.getSheetByName(SHEET_DATA_NAME);
  if (!dataSheet) {
    dataSheet = ss.insertSheet(SHEET_DATA_NAME);
    dataSheet.appendRow(DATA_HEADERS);
    dataSheet.setFrozenRows(1);
    dataSheet.setColumnWidth(1, 300);
    dataSheet.setColumnWidth(2, 800);
  }
  
  return { listSheet: listSheet, dataSheet: dataSheet };
}

/**
 * ç”¢ç”Ÿä¸€å€‹ç°¡æ˜“çš„å”¯ä¸€ID (UUID v4)
 */
function generateUUID() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

/**
 * å»ºç«‹ä¸€å€‹æ¨™æº–çš„ JSON å›æ‡‰
 */
function createJsonResponse(data) {
  return ContentService.createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}
</code></pre>
              </div>

              <h3>æ­¥é©ŸäºŒï¼šå»ºç«‹ Google è©¦ç®—è¡¨èˆ‡é–‹å•Ÿ Apps Script</h3>
              <ol>
                  <li>å‰å¾€ <a href="https://sheets.new" target="_blank">Google è©¦ç®—è¡¨</a> å»ºç«‹ä¸€ä»½æ–°çš„ã€ç©ºç™½çš„è©¦ç®—è¡¨ã€‚</li>
                  <li>åœ¨è©¦ç®—è¡¨é é¢ä¸­ï¼Œé»æ“Šé ‚éƒ¨é¸å–®çš„ã€Œæ“´å……åŠŸèƒ½ã€ > ã€ŒApps Scriptã€ã€‚</li>
              </ol>

              <h3>æ­¥é©Ÿä¸‰ï¼šè²¼ä¸Šç¨‹å¼ç¢¼ä¸¦åˆæ¬¡éƒ¨ç½²</h3>
              <ol>
                  <li>åœ¨ Apps Script ç·¨è¼¯å™¨ä¸­ï¼Œåˆªé™¤æ‰€æœ‰é è¨­ç¨‹å¼ç¢¼ï¼Œç„¶å¾Œå°‡æ‚¨å‰›å‰›è¤‡è£½çš„ç¨‹å¼ç¢¼å®Œæ•´è²¼ä¸Šã€‚</li>
                  <li>é»æ“Šä¸Šæ–¹çš„ã€Œå„²å­˜å°ˆæ¡ˆã€åœ–ç¤ºã€‚</li>
                  <li>é»æ“Šå³ä¸Šè§’çš„è—è‰²æŒ‰éˆ•ã€Œéƒ¨ç½²ã€ > ã€Œæ–°å¢éƒ¨ç½²ä½œæ¥­ã€ã€‚</li>
                  <li>åœ¨ã€Œé¸å–é¡å‹ã€æ—é»æ“Šé½’è¼ªåœ–ç¤ºï¼Œé¸æ“‡ã€Œç¶²è·¯æ‡‰ç”¨ç¨‹å¼ã€ã€‚</li>
                  <li>**éå¸¸é‡è¦**ï¼šå°‡ã€Œèª°å¯ä»¥å­˜å–ã€è¨­å®šç‚ºã€Œ**ä»»ä½•äºº**ã€ã€‚</li>
                  <li>é»æ“Šã€Œéƒ¨ç½²ã€ï¼Œä¸¦åœ¨è·³å‡ºçš„è¦–çª—ä¸­å®Œæˆæˆæ¬Š (å¯èƒ½æœƒæç¤ºä¸å®‰å…¨ï¼Œè«‹é»æ“Šã€Œé€²éšã€ä¸¦ç¹¼çºŒ)ã€‚</li>
                  <li>æˆæ¬Šå¾Œï¼Œè¤‡è£½ç”¢ç”Ÿçš„ã€Œç¶²è·¯æ‡‰ç”¨ç¨‹å¼ URLã€ã€‚</li>
              </ol>
              <p>å®Œæˆä»¥ä¸Šæ­¥é©Ÿå¾Œï¼Œæ‚¨å°±å¯ä»¥å°‡è¤‡è£½çš„ URLï¼Œé€éå‰é¢æåˆ°çš„å…©ç¨®æ–¹å¼ä¹‹ä¸€ï¼Œè¨­å®šåˆ°æœ¬å·¥å…·ä¸­ã€‚</p>
          </div>
          <div class="modal-buttons">
              <button id="btn_close_help" class="btn">é—œé–‰</button>
          </div>
      </div>
  </div>

  <div id="link_modal_overlay" class="modal-overlay">
      <div class="modal-content">
          <h2>è¨­å®šç¯€é»è¶…é€£çµ</h2>
          <p>è«‹è²¼ä¸Šè¦é€£çµçš„ç¶²å€ (ç•™ç©ºå‰‡æ¸…é™¤é€£çµ):</p>
          <input type="text" id="link_url_input" class="modal-input" placeholder="https://example.com">
          <div class="modal-buttons">
              <button id="btn_cancel_link" class="btn">å–æ¶ˆ</button>
              <button id="btn_save_link" class="btn">å„²å­˜</button>
          </div>
      </div>
  </div>

  <div id="image_url_modal_overlay" class="modal-overlay">
      <div class="modal-content">
          <h2>è¨­å®šç¯€é»åœ–ç‰‡</h2>
          
          <!-- Manual URL Input -->
          <p>è«‹è²¼ä¸Šåœ–ç‰‡çš„ç¶²å€ (ç•™ç©ºå‰‡æ¸…é™¤åœ–ç‰‡):</p>
          <input type="text" id="image_url_input" class="modal-input" placeholder="https://example.com/image.png">

          <hr style="margin: 20px 0; border-top: 1px solid #ccc;">

          <!-- Google Doc Extractor -->
          <p>æˆ–å¾å·²ç™¼ä½ˆçš„ Google æ–‡ä»¶ç¶²å€æå–åœ–ç‰‡:</p>
          <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <input type="url" id="gdoc_url_input" class="modal-input" placeholder="https://docs.google.com/document/d/e/.../pub" style="flex-grow: 1;">
            <button id="btn_fetch_gdoc" class="btn" style="background-image: linear-gradient(45deg,#42a5f5,#1e88e5);">æå–</button>
          </div>
          <div id="gdoc_status" style="text-align: center; margin: 10px 0;"></div>
          <div id="gdoc_image_results" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 5px; display: flex; flex-wrap: wrap; gap: 5px;">
            <!-- Fetched images will appear here -->
          </div>

          <div class="modal-buttons">
              <button id="btn_cancel_image_url" class="btn">å–æ¶ˆ</button>
              <button id="btn_save_image_url" class="btn">å„²å­˜</button>
          </div>
      </div>
  </div>

  <div id="prompt_modal_overlay" class="modal-overlay">
    <div class="modal-content">
        <h2>åƒè€ƒ Prompt</h2>
        <div class="modal-body">
            <div class="code-container" style="position: relative;">
                <button id="btn_copy_prompt" class="btn" style="position: absolute; top: 10px; right: 10px; background-image: linear-gradient(45deg,#66bb6a,#388e3c);">è¤‡è£½</button>
                <pre><code id="prompt_text_block"># ä»»å‹™ï¼šç”Ÿæˆå¿ƒæ™ºåœ– Markdown èªæ³• (ç´”æ–‡å­—ç‰ˆ)

è«‹ä½ æ‰®æ¼”ä¸€ä½ç‰¹å®šé ˜åŸŸçš„å°ˆå®¶ï¼Œç‚ºã€Œ[è«‹å¡«å…¥æ‚¨çš„å°è±¡]ã€ï¼ˆä¾‹å¦‚ï¼šåœ‹å°é«˜å¹´ç´šå­¸ç”Ÿã€åˆå­¸è€…ã€å°ˆæ¥­äººå£«ç­‰ï¼‰è¨­è¨ˆä¸€ä»½é—œæ–¼ã€Œ[è«‹å¡«å…¥æ‚¨çš„ä¸»é¡Œ]ã€çš„ç´”æ–‡å­—å¿ƒæ™ºåœ–ã€‚

## æ ¼å¼è¦æ±‚ (æ¥µç‚ºé‡è¦)ï¼š

è«‹ä½ ã€Œå‹™å¿…ã€ä¸”ã€Œåªèƒ½ã€ä½¿ç”¨ä»¥ä¸‹çš„ Markdown æ ¼å¼ä¾†ç”Ÿæˆå…§å®¹ï¼š

1.  **å±¤ç´šçµæ§‹**ï¼š
    * **æ ¹ç¯€é» (Root)**ï¼šå¿…é ˆä½¿ç”¨ä¸€å€‹ `#` (H1)ã€‚
    * **ä¸»åˆ†æ”¯**ï¼šå¿…é ˆä½¿ç”¨å…©å€‹ `##` (H2)ã€‚
    * **å­åˆ†æ”¯**ï¼šå¿…é ˆä½¿ç”¨ä¸‰å€‹ `###` (H3)ã€‚
    * **å­«åˆ†æ”¯**ï¼šå¿…é ˆä½¿ç”¨å››å€‹ `####` (H4)ï¼Œä»¥æ­¤é¡æ¨ã€‚
    * (è«‹å‹¿ä½¿ç”¨ `-` æˆ– `*` åˆ—è¡¨ç¬¦è™Ÿä¾†è¡¨ç¤ºå±¤ç´š)ã€‚

2.  **é™åˆ¶**ï¼š
    * æ¯ä¸€è¡Œå°±æ˜¯ä¸€å€‹ç¯€é»ã€‚
    * å…§å®¹ä¸­**ä¸å¯ä»¥**åŒ…å«ä»»ä½•è¶…é€£çµ (ä¾‹å¦‚ `[text](url)`) æˆ–åœ–ç‰‡ (ä¾‹å¦‚ `![alt](url)`)ã€‚
    * ç¬¬ä¸€è¡Œ**å¿…é ˆæ˜¯** `#` (H1) æ ¹ç¯€é»ã€‚

## ç¯„ä¾‹çµæ§‹ï¼š

'''markdown
# ç¯„ä¾‹ä¸»é¡Œ
## é‡é»ä¸€
### å­é‡é» 1.1
### å­é‡é» 1.2
## é‡é»äºŒ
### å­é‡é» 2.1
### å­é‡é» 2.2
#### å­é‡é» 2.2.1
## é‡é»ä¸‰
'''</code></pre>
            </div>
        </div>
        <div class="modal-buttons">
            <button id="btn_close_prompt" class="btn">é—œé–‰</button>
        </div>
    </div>
  </div>

  <script src="mindmap.js"></script>
</body>
</html>